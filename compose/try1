name: rocketchat-platform

services:

  traefik:
    image: traefik:v2.11
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rocketchat.rule=Host(`${ROCKETCHAT_DOMAIN}`)"
      - "traefik.http.routers.rocketchat.entrypoints=websecure"
      - "traefik.http.routers.rocketchat.tls=true"
      - "traefik.http.services.rocketchat.loadbalancer.server.port=3000"
      - "traefik.http.routers.rocketchat-http.entrypoints=web"
      - "traefik.http.routers.rocketchat-http.rule=Host(`quickpick.coach`)"
    command:
      - "--providers.docker=true"
      - "--providers.file.directory=/certs"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/certs:/certs"
      - "./traefik/dynamic.yaml:/certs/dynamic.yaml"
    networks:
      - botnet

  mongodb:
    build:
      context: ../mongodb/docker
    image: spkane/mongo:5.0
    restart: unless-stopped
    environment:
      MONGODB_REPLICA_SET_MODE: primary
      MONGODB_REPLICA_SET_NAME: rs0
      MONGODB_PORT_NUMBER: 27017
      MONGODB_INITIAL_PRIMARY_HOST: mongodb
      MONGODB_INITIAL_PRIMARY_PORT_NUMBER: 27017
      MONGODB_ADVERTISED_HOSTNAME: mongodb
      MONGODB_ENABLE_JOURNAL: "true"
      ALLOW_EMPTY_PASSWORD: "yes"
    volumes:
      - mongodb-rocketchat:/bitnami/mongodb
    networks:
      - botnet
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  rocketchat:
    platform: linux/amd64
    image: rocketchat/rocket.chat:7.13.3
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - "../rocketchat/data/uploads:/app/uploads"
    environment:
      ROOT_URL: https://quickpick.coach
      PORT: 3000
      MONGO_URL: mongodb://mongodb:27017/rocketchat?replicaSet=rs0
      MONGO_OPLOG_URL: mongodb://mongodb:27017/local?replicaSet=rs0
      DEPLOY_METHOD: docker
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rocketchat.rule=Host(`${ROCKETCHAT_DOMAIN}`)" 
      - "traefik.http.routers.rocketchat.entrypoints=websecure"
      - "traefik.http.routers.rocketchat.tls=true"
      - "traefik.http.services.rocketchat.loadbalancer.server.port=3000"
    networks:
      - botnet

        #hubot:
    # platform: linux/amd64
      # image: rocketchat/hubot-rocketchat:latest
      # restart: unless-stopped
      #   depends_on:
      #  mongodb:
        #   condition: service_healthy
          # volumes:
      #   - "../hubot/scripts:/home/hubot/scripts"
        # environment:
      #   ROCKETCHAT_URL: rocketchat:3000
        #   ROCKETCHAT_ROOM: GENERAL
        #  ROCKETCHAT_USER: hubot
        #   ROCKETCHAT_PASSWORD: ${HUBOT_ROCKETCHAT_PASSWORD:?HUBOT_ROCKETCHAT_PASSWORD must be set!}
        #  BOT_NAME: bot
        #  networks:
      #  - botnet
        # healthcheck:
      # test: ["CMD-SHELL", "curl -f http://rocketchat:3000/api/info || exit 1"]
        #interval: 10s
        # timeout: 5s
        # retries: 5
        #      start_period: 20s

networks:
  botnet:
    driver: bridge

volumes:
  mongodb-rocketchat:

